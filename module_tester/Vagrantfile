require 'getoptlong'

# options need to come directly after the vagrant thingy
opts = GetoptLong.new(
  [ '--box', GetoptLong::OPTIONAL_ARGUMENT ],
  [ '--force', GetoptLong::OPTIONAL_ARGUMENT ],
  [ '--break-provisioning', GetoptLong::OPTIONAL_ARGUMENT ],
  [ '--provision', GetoptLong::OPTIONAL_ARGUMENT ]
) 


# "archlinux/archlinux" 
# "suse/something???"
boxParam='generic/debian10'
haltProvisioning=false

opts.each do |opt, arg|
  case opt
    when '--box'
      boxParam=arg
    when '--break-provisioning'
      haltProvisioning=true
  end
end

cpus = 8
memory = 8192
# box = "generic/ubuntu1904"
# box = "generic/debian10"
# box = "generic/opensuse15
box = "#{boxParam}"
hostname = "fio.local"

$proxy = <<-SHELL
    proxy=#{ENV['APT_PROXY']}
    if [ "$proxy" != "" ]; then
      echo "Acquire::http::Proxy \\\"$proxy\\\";" > /etc/apt/apt.conf.d/01proxy
    fi
SHELL

$resolvFix = <<-SHELL
    echo "DNS=192.168.86.1" >> /etc/systemd/resolved.conf
    systemctl daemon-reload
    systemctl restart systemd-resolved
SHELL

Vagrant.configure("2") do |config|
    config.vm.box = box
    config.vm.host_name = hostname

    config.vm.provider :libvirt do |lv, override|
        lv.cpus = cpus
        lv.memory = memory
        lv.pci :bus => '0x0b', :slot => '0x00', :function => '0x0'
        lv.pci :bus => '0x0c', :slot => '0x00', :function => '0x0'
        if #{box}.match(/suse/i)
            lv.disk_bus = "sata"
        end
        if #{box}.match(/archlinux/i)
            lv.disk_bus = "virtio"
            config.vm.provision "shell", inline: $resolvFix, privileged: true
        end
        if #{box}.match(/debian/i) or #{box}.match(/ubuntu/)
            config.vm.provision "shell", inline: $proxy, privileged: true
        end
    end
    config.vm.provision "file", source: "../envfile", destination: "envfile"
    config.vm.provision "shell", path: "scripts/phase_1.sh"
    config.vm.provision :reload
    if not haltProvisioning
        config.vm.provision "shell", path: "scripts/phase_1_1.sh"
        config.vm.provision "shell", path: "scripts/phase_1_2.sh"
        config.vm.provision "shell", path: "scripts/phase_2.sh"
        config.vm.provision "shell", path: "scripts/phase_3.sh"
        config.vm.provision "shell", path: "scripts/test_tgz.sh"
        config.vm.provision "shell", path: "scripts/test_page_cache.sh"
        config.vm.provision "shell", path: "scripts/phase_4.sh"
    end
end
